name: Build and Release Blog

on:
  push:
    branches:
      - main
    paths:
      - 'source/**'
      - 'themes/**'
      - 'scaffolds/**'
      - '_config.yml'
      - '_config.landscape.yml'
      - 'package.json'
      - '.github/workflows/**'

  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-blog:
    name: Build and Release Blog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: |
          pnpm install
          if [ -f themes/next/package.json ]; then
            cd themes/next
            pnpm install || true
          fi

      - name: Build static site
        run: pnpm run build

      - name: Check built files
        run: ls -R public

      - name: Zip built blog
        working-directory: public
        run: zip -r $GITHUB_WORKSPACE/blog-release.zip .

      - name: Force-update blog-main tag
        run: |
          git tag -f blog-main
          git push origin blog-main --force

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: blog-main
          name: Blog Release (main)
          files: blog-release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Remote Deploy via Webhook
        run: |
          curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}?token=${{ secrets.DEPLOY_WEBHOOK_TOKEN }}" \
          || echo "⚠️ Webhook failed, continuing anyway."
